@page "/login"
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Authentication
@using ULO.Models.Entities
@using ULO.UI.Models
@using ULO.UI.Models.Entities
@inject IJSRuntime JS
@inject ULODbContext _dbcontext
@inject NavigationManager _navigationManager

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="css/style.css">
<script src="js/script.js" defer></script>

<style>
    .cookie-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        text-align: center;
        z-index: 1000;
    }

</style>


<div class="container" id="container">
        <span class="text-danger">@errorLoginMessage</span>
        <EditForm Model="@LoginUser" OnValidSubmit="Login" FormName="LoginForm">
            <DataAnnotationsValidator />
            <h1>Zaloguj!</h1>
            <InputText @bind-Value="LoginUser.Login" placeholder="Login" />
            <ValidationMessage For="() =>LoginUser.Login" />
            <InputText @bind-Value="LoginUser.Password" placeholder="Password" type="password" />
            <ValidationMessage For="() =>LoginUser.Password" />
            <button>Zaloguj!</button>
        </EditForm>
    <button style="width:100%;"><a style="color:#fff;" href="/register">Nie masz jeszcze konta? Zarejestruj się!</a></button>
</div>
<div class="cookie-banner">
    <p>
        Ta strona używa ciasteczek oraz zapisuje dane w bazie danych w celu poprawy jakości usług.
        Kontynuując korzystanie z serwisu, akceptujesz te zasady. Kliknij przycisk, aby zaakceptować.
    </p>
</div>

@code {
    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }

    [SupplyParameterFromForm(FormName = "LoginForm")]
    public LoginUserDto LoginUser { get; set; } = new();

    [SupplyParameterFromForm(FormName = "RegisterForm")]
    public RegisterUserDto RegisterUser { get; set; } = new();

    private string? errorLoginMessage;
    private string? errorRegisterMessage;

    private async Task Login()
    {
        if (LoginUser.Login is null) return;

        var userAccount = _dbcontext.Users.Where(x => x.Login == LoginUser.Login).FirstOrDefault();
        if (userAccount is null || userAccount.Password != LoginUser.Password)
        {
            errorLoginMessage = "Invalid User Name or Passowrd";
            return;
        }

        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.Name, LoginUser.Login),
            new Claim(ClaimTypes.Role, userAccount.Rank)
        };

        await LogLoginDate(LoginUser.Login);

        var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        var principal = new ClaimsPrincipal(identity);
        await HttpContext.SignInAsync(principal);
        _navigationManager.NavigateTo("/");
    }
    public async Task Register()
    {
        bool checkUser = CheckUser(RegisterUser.Login);
        if (checkUser is true)
        {
            errorRegisterMessage = "Login jest zajęty";
            return;
        }

        User user = new User
        {
            Login = RegisterUser.Login,
            Email = RegisterUser.Email,
            FirstName = RegisterUser.FirstName,
            LastName = RegisterUser.LastName,
            Password = RegisterUser.Password,
            Rank = "User",
            Created = DateTime.Now
        };

        await _dbcontext.Users.AddAsync(user);
        await _dbcontext.SaveChangesAsync();

        _navigationManager.NavigateTo("/login");

    }
    private bool CheckUser(string login)
    {
        var result = _dbcontext.Users.Where(x => x.Login == login).FirstOrDefault();
        if (result is null) return false;
        return true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("eval", "script.js");
        }
    }
    public async Task LogLoginDate(string login)
    {
        var userLogLogin = _dbcontext.Users.Where(x => x.Login == login).FirstOrDefault();

        LogLogin log = new LogLogin
        {
            UserId = userLogLogin.Id,
            Created = DateTime.Now
        };
        await _dbcontext.AddAsync(log);
        await _dbcontext.SaveChangesAsync();
    }
}
